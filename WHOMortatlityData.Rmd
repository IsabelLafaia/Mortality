---
title: "WHO Moratlity Data"
author: "Saghir Bashir & Joana Pereira"
date: "9 October 2016"
output: html_document
---

In this document, the steps to *tidy* the [World Health Organisation's (WHO)](www.who.int) mortality data for use in R are documented. The following steps are presented.

* Data source: <http://www.who.int/healthinfo/mortality_data/en/>
  + It is assumed that data has been downloaded
* Reading in the WHO mortality data
* Reading the International Classificaion of Diseases data
* Keep the **neoplasm** data for ICD10 part 1
  + Tranform the data into long format for the number of deaths
* Transform the population data in long format
* Merge the long population data to the long neoplasm data
  + Care has to be taken with respect to the format of the age groups. 
  + Combine the youngest age groups into a new 0-4 years. 
  + Consider adding an **all** age group category (**not urgent**)
* Calculate the mortality rate per 100,000 population in a new variable
  + rate = (100000*deaths)/pop
* Write a function that will extract data based on country, cause of death, year and sex
  + If any of these are left blank then all the data is extracted
  + A data frame containing the requested data should be returned.
* Next steps will defined later
  * Sumamry graphs
  * Summary tables
  
**Note** There is no not need to use *R Shiny* for this exercise. Only program in this R markdown document.

## Data source

The data was downloaded from <http://www.who.int/healthinfo/mortality_data/en/>. It is assumed that data has been downloaded and resides in a directory "OrigData"

## Reading in the WHO mortality data

The following code will automatically read in the WHO mortality data.
```{r ReadWHOdata, echo=FALSE}
# Load libraries
library(stringr)
library(readr)
library(tibble)

# Set the directory where you have saved the data.
# This is not a great solution but it works and is easier for the moment, Later it should change.
setwd("WHOdata/")

# Select the data files (exclude .zip, .doc, .xls)
csvWHO <- list.files(path = ".", full.names = FALSE) %>%
str_subset("^((?!zip|doc|xls).)*$")

# Use the lapply to read all the data into one list
dataList <- lapply(csvWHO, read_csv, guess_max = min(300000, Inf))

# Extract the data into data.frames (tbl) but start by giving them the dataest you want.
# I convert them to lower case as they are not consistent in the original.
names(dataList) <- str_to_lower(csvWHO)
list2env(dataList, envir = .GlobalEnv)

# dataList is not longer needed so we will remove it.
rm(dataList)
# Removing the ICD 7, 8, 9 and 10 part 2 data as we will not use them for the moment.
# Also we do not want to have problems with the memory
rm(morticd7, morticd8, morticd9, morticd10_part2)

# Some garbage collection to free up the memory (although this is something that is
# automatically by kernel). In future we may not need this step.
gc()
```

## Reading the International Classificaion of Diseases data

**Joana:** Please read in the data form the word document here.

```{r readICDdata, echo=TRUE}
library(xml2)

get_tbls <- function(word_doc) {
  
  tmpd <- tempdir()
  tmpf <- tempfile(tmpdir=tmpd, fileext=".zip")
  
  file.copy(word_doc, tmpf)
  unzip(tmpf, exdir=sprintf("%s/docdata", tmpd))
  
  doc <- read_xml(sprintf("%s/docdata/word/document.xml", tmpd))
  
  unlink(tmpf)
  unlink(sprintf("%s/docdata", tmpd), recursive=TRUE)

  ns <- xml_ns(doc)
  
  tbls <- xml_find_all(doc, ".//w:tbl", ns=ns)
  
  lapply(tbls, function(tbl) {
    
    cells <- xml_find_all(tbl, "./w:tr/w:tc", ns=ns)
    rows <- xml_find_all(tbl, "./w:tr", ns=ns)
    dat <- data.frame(matrix(xml_text(cells), 
                             ncol=(length(cells)/length(rows)), 
                             byrow=TRUE), 
                      stringsAsFactors=FALSE)
    colnames(dat) <- dat[1,]
    dat <- dat[-1,]
    rownames(dat) <- NULL
    dat
    
  })
  
}


doc <- get_tbls("Documentation_15sep2016.zip")
names(doc) <- paste0("docx", 1:length(doc))
list2env(doc, envir = .GlobalEnv)
rm(docx1, docx2, docx3, docx4, docx5, docx6, docx7, docx8, docx9, docx10, docx11, docx12, docx13, docx14, docx15)
```


### Keep the **neoplasm** data for ICD10 parts 1 

**To do:** Tranform the data into long format for the number of deaths

**Hints:** Use `gather()`, `filter()`, `str_to_upper()` (or an case insensitive regex to select neoplasm data). 

```{r keepNeoplasm, echo=TRUE}
library(dplyr)

# melanoma, lymphoma, Leukaemia and Neoplasm
neoplasmCodes <- docx16 %>%
        bind_rows(docx17) %>%
        filter(
        grepl("neoplasm", str_to_lower(Cause)) |
        grepl("melanoma", str_to_lower(Cause)) |
        grepl("lymphoma", str_to_lower(Cause)) |
        grepl("leukaemia", str_to_lower(Cause))
        )

#Dataset with all the mortality data from melanoma, lymphoma, Leukaemia and Neoplasms
keepNeoplasm <- morticd10_part1 %>%
        filter(Cause %in% neoplasmCodes$Code)

Countries <- keepNeoplasm %>%
        inner_join(country_codes, by = "Country") %>%
        select(-Admin1,
        -SubDiv,
        -IM_Frmat,
        -IM_Deaths1,
        -IM_Deaths2,
        -IM_Deaths3,
        -IM_Deaths4)

```



### Transform the population data in long format

```{r popLong, echo=TRUE}

popLong <- pop   %>%
        select(-Admin1, -SubDiv, -Lb) %>%
        gather("Age", "Population", 5:30) %>%
#        mutate(mergevar = paste(Country, Year, Sex, Frmat, Age, sep = "_"))
        mutate(GroupAge  = as.numeric(str_replace(Age,"Pop", ""))) %>%
        select(-Age)
                

```


### Merging the population data to the neoplasm mortality data

  * Care has to be taken with respect to the format of the age groups. 
  * Combine the youngest age groups into a new 0-4 years. 
  * Consider adding an **all** age group category (**not urgent**)
  * Calculate the mortality rate per 100,000 population in a new variable
    + rate = (100000*deaths)/pop

```{r mortalityPop, echo=TRUE}

mortalityPop <- keepNeoplasm %>%
        select(-Admin1,
        -SubDiv,
        -IM_Frmat,
        -IM_Deaths1,
        -IM_Deaths2,
        -IM_Deaths3,
        -IM_Deaths4) %>%
        gather("Age", "Deaths", 7:32) %>%
#       mutate(mergevar = paste(Country, Year, Sex, Frmat, Age, sep = "_")) %>% 
#        left_join(popLong, by = 'mergevar')

        mutate(GroupAge  = as.numeric(str_replace(Age, "Deaths", "")))  %>%
        select(-Age) %>%
        left_join(popLong, by = c("Country"="Country", "Year"="Year", "Sex"="Sex", "Frmat"="Frmat", "GroupAge" = "GroupAge" ))





# d1 <- data_frame(
#   x = letters[1:3],
#   y = LETTERS[1:3],
#   a = c("1","2","3")
# )
# 
# d2 <- data_frame(
#   x2 = letters[3:1],
#   y2 = LETTERS[3:1],
#   b =  c("4","5","6")
# )
# 
# d3 <- data_frame(
#   x = letters[3:1],
#   y = LETTERS[3:1],
#   b =  c("7","8","9")
# )
# 
# 
# ljd1d2 <- left_join(d1, d2, by = c("x" = "x2", "y" = "y2"))
# 
# ljd1d3 <- left_join(d1, d3, by = c("x", "y")) 




 
```



## Write a function that will extract data based on country, cause of death, year and sex
  * If any of these are left blank then all the data is extracted
  * A data frame containing the requested data should be returned.

```{r}
getWHOdata <- function(country, causes, year, sex){
  # country - Vector of countries to be filtered
  #   cause - Vector of causes of death to be filtered
  #    year - Vector of years to be filtered
  #     sex - Vector of gender to be filtered

}


```

# Comparing results
```{r compareResults}


m10codes <- morticd10_part1 %>%
group_by(Cause) %>%
summarise(n10 = n())

neoCode <- keepNeoplasm %>%
group_by(Cause) %>%
summarise(nneo = n()) %>%
right_join(m10codes, by = "Cause") %>%
rename(Code = Cause) %>%
left_join(docx16, by = "Code")



```



### Next steps

Once the above steps have been completed, the next steps will be defined. They will include:
  * Sumamry graphs
  * Summary tables
  


